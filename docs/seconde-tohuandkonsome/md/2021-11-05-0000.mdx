---
title: 徳丸さんのSPAのセキュリティー入門メモ
time: 2021-11-05 00:00
tag: ['nextjs']
---

# はじめに

## CORS観点から見た、Cookie vs Token(localStorage)

- Cookieの場合、CORS不備があると、フィッシングサイトでもCookieを送信してしまい、悪用される可能性がある。
- Token(localStorage)の場合、CORS不備があっても、フィッシングサイトから、localStorageは参照できないので悪用はしにくい。

## JWTの認証/認可

### 考えなきゃいけないところ

サーバー側でのToken破棄方法。
ケースとしては、ファッシングサイトで、ID/Passwordを入力してしまったときの対応があるのかないのか。
ユーザーは即座にパスワードを変更したとしても、既に発行されたtokenを無効にするにはどうしたらいいのだろう。  

一般的にはトークンの有効期限を短くすることが考えられる。
トークンの有効期限が短くって、すぐにログアウト状態になると意味がないので、リフレッシュトークンを用いて都度トークンを再発行する仕組みを用意しておく。  

ただ、トークンの有効期限が短いといっても、30分〜1時間程度はあるのでこの間は漏れたtokenが利用できてしまう状態になる。  
発行したtokenを管理して、失効させる仕組みを取ると、結局サーバ側で状態を持つのと変わらないって話になる。

リフレッシュトークンだけ失効させる仕組みをとるっていう考え方もある？ただ、これも状態をもつよね。
※リフレッシュトークンは有効期限が長いので。

結論は特になくって、メリット/デメリットをわかった上で導入しようぜってこと。  
軸は、パスワード変更時の即時ログアウトが必要かどうか。

ちなみに、Laravel Sancutmは、tokenをデータベースに保持させるやり方がある。  
Cookieベースのセッションと何が違うんだっけとも思った。  
が、サービス単体で考えるとCORS不備の観点で若干メリットがあるのと、OAuth/IDPではtokenだからかな。






