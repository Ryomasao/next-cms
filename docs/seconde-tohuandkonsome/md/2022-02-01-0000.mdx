---
title: npmパッケージガーデニング
time: 2022-02-01 00:00
tag: ['npm']
---

# パッケージガーデニング

## 前提

yarn は未だに 1 系

```
 > yarn --version
1.22.15
```

## ストーリー

```
next@12.0.7 requires node-fetch@2.6.1
```

以下コマンドを叩くと、どのパッケージに脆弱性があって、それを利用しているパッケージが表示させる。

今回は、`node-fetch`と`next`にそれぞれ脆弱性があったケース。

```
yarn audit v1.22.15
┌───────────────┬──────────────────────────────────────────────────────────────┐
│ high          │ node-fetch is vulnerable to Exposure of Sensitive            │
│               │ Information to an Unauthorized Actor                         │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Package       │ node-fetch                                                   │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Patched in    │ >=2.6.7                                                      │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Dependency of │ next                                                         │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Path          │ next > node-fetch                                            │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ More info     │ https://www.npmjs.com/advisories/1006899                     │
└───────────────┴──────────────────────────────────────────────────────────────┘
┌───────────────┬──────────────────────────────────────────────────────────────┐
│ moderate      │ DOS Vulnerability in next.js                                 │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Package       │ next                                                         │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Patched in    │ >=12.0.9                                                     │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Dependency of │ next                                                         │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Path          │ next                                                         │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ More info     │ https://www.npmjs.com/advisories/1006916                     │
└───────────────┴──────────────────────────────────────────────────────────────┘
┌───────────────┬──────────────────────────────────────────────────────────────┐
│ high          │ node-fetch is vulnerable to Exposure of Sensitive            │
│               │ Information to an Unauthorized Actor                         │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Package       │ node-fetch                                                   │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Patched in    │ >=2.6.7                                                      │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Dependency of │ msw                                                          │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Path          │ msw > node-fetch                                             │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ More info     │ https://www.npmjs.com/advisories/1006899                     │
└───────────────┴──────────────────────────────────────────────────────────────┘
3 vulnerabilities found - Packages audited: 600
```

node-fetch の依存関係は以下の通り

```
-msw
--node-fetch

-next
--node-fetch
```

next の依存関係は next 自身のみ

```
next
```

Github の場合、脆弱性があると自動で修正する PR を出してくれる。  
具体的には、`yarn.lock`を直接変更してバージョンを変更する PR がでてくる。

> Q. セキュリティパッチをあてている修正後のバージョンが package.json で指定しているセマンティックバージョニングの範囲外の場合はどうなるんだろう。自動で PR が作られずにセキュリティアラートだけ出してくれるのかな。
> Q. node-fetch の脆弱性の場合も、PR が出せないパターンだった。どのケースの場合、これに該当するのかわかってない。パッケージ A がパッケージ B に依存していて、パッケージ B に脆弱性がある場合？

ひとまずコマンドを叩いて修正することにする。

まずは、`next`のほうから。

```
yarn upgrade next@12.0.9
```

`yarn upgrade`は package.json を更新しないと書いてあったんだけど更新した。なんでだろ。
